# Shelly Dashboard mit Grafana ‚Äì Professionelle Visualisierung

*Teil 5b: Grafana als Erweiterung zum PHP-Dashboard*

Im vorherigen Teil hast du ein eigenes PHP-Dashboard gebaut ‚Äì funktional, schlank und unter deiner vollen Kontrolle. Doch was, wenn du mehr willst? Interaktive Zeitr√§ume, Zoom-Funktionen, automatische Alerts oder einfach professionellere Optik?

Hier kommt **Grafana** ins Spiel. In diesem Artikel zeige ich dir, wie du Grafana mit deiner bestehenden Shelly-Datenbank verbindest und in wenigen Minuten aussagekr√§ftige Dashboards erstellst.

---

## 1. Warum Grafana?

**PHP-Dashboard vs. Grafana ‚Äì wann was?**

| Kriterium | PHP-Dashboard | Grafana |
|-----------|---------------|---------|
| Installation | Keine (l√§uft auf vorhandenem Webserver) | Eigener Dienst n√∂tig |
| Anpassbarkeit | Volle Kontrolle √ºber jeden Pixel | Vorgefertigte Panels |
| Lernkurve | PHP/HTML/JS-Kenntnisse n√∂tig | Klick-basiert, wenig Code |
| Features | Nur was du selbst baust | Alerting, Variablen, Annotations |
| Ressourcen | Minimal | ~200 MB RAM |
| Zeitaufwand | Stunden f√ºr gutes Design | Minuten f√ºr fertiges Dashboard |

**Fazit:** Das PHP-Dashboard ist perfekt zum Lernen und f√ºr volle Kontrolle. Grafana ist der n√§chste Schritt, wenn du schnell professionelle Ergebnisse willst ‚Äì ohne jede Zeile selbst zu schreiben.

---

## 2. Grafana installieren

Falls Grafana noch nicht l√§uft, hier die Installation f√ºr Debian/Ubuntu:

### 2.1 Repository hinzuf√ºgen und installieren

```bash
# Abh√§ngigkeiten
sudo apt install -y apt-transport-https software-properties-common wget

# Grafana GPG-Key
sudo mkdir -p /etc/apt/keyrings/
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null

# Repository hinzuf√ºgen
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list

# Installieren
sudo apt update
sudo apt install grafana -y
```

### 2.2 Dienst starten

```bash
sudo systemctl daemon-reload
sudo systemctl enable grafana-server
sudo systemctl start grafana-server
```

### 2.3 Erster Login

√ñffne im Browser: `http://deine-server-ip:3000`

- **Benutzer:** admin
- **Passwort:** admin

Beim ersten Login wirst du aufgefordert, das Passwort zu √§ndern.

---

## 3. MySQL-Datenquelle einrichten

Jetzt verbinden wir Grafana mit deiner Shelly-Datenbank.

### 3.1 Datenquelle hinzuf√ºgen

1. Links im Men√º: **Connections** ‚Üí **Data sources**
2. Klick auf **Add data source**
3. W√§hle **MySQL**

### 3.2 Verbindungsdaten eingeben

| Feld | Wert |
|------|------|
| Host | `192.168.2.xxx:3306` (deine DB-IP) |
| Database | `shelly_data` |
| User | `shelly_user` |
| Password | Dein Datenbank-Passwort |

Falls Grafana auf dem gleichen Server wie die DB l√§uft, kannst du als Host `localhost:3306` verwenden.

### 3.3 Verbindung testen

Klick auf **Save & test**. Bei Erfolg erscheint: *"Database Connection OK"*

**Fehler?** H√§ufige Ursachen:
- Firewall blockiert Port 3306
- MySQL-User hat keine Berechtigung f√ºr Remote-Zugriff
- Falsches Passwort

---

## 4. Erstes Dashboard erstellen

### 4.1 Neues Dashboard anlegen

1. Links im Men√º: **Dashboards**
2. Klick auf **New** ‚Üí **New Dashboard**
3. Klick auf **Add visualization**

### 4.2 Temperatur-Panel (Zeitreihe)

W√§hle deine MySQL-Datenquelle und gib folgende Query ein:

```sql
SELECT
  timestamp AS time,
  temperature AS 'Temperatur',
  device_name
FROM sensor_data
WHERE device_id = '7c:c6:b6:97:33:ac'
  AND $__timeFilter(timestamp)
ORDER BY timestamp ASC
```

**Einstellungen im Panel:**
- **Visualization:** Time series
- **Title:** Temperaturverlauf
- **Unit:** Celsius (¬∞C) ‚Äì unter "Standard options"

**üí° `$__timeFilter(timestamp)`** ist eine Grafana-Variable, die automatisch den ausgew√§hlten Zeitraum filtert. So funktioniert der Zeitraum-Selektor oben rechts.

### 4.3 Luftfeuchtigkeit hinzuf√ºgen

Klick auf **Add query** im gleichen Panel und f√ºge hinzu:

```sql
SELECT
  timestamp AS time,
  humidity AS 'Luftfeuchtigkeit',
  device_name
FROM sensor_data
WHERE device_id = '7c:c6:b6:97:33:ac'
  AND $__timeFilter(timestamp)
ORDER BY timestamp ASC
```

Unter **Standard options** ‚Üí **Unit**: Percent (0-100)

So hast du Temperatur und Feuchtigkeit in einem Panel mit zwei Y-Achsen.

### 4.4 Leistungs-Panel

Neues Panel hinzuf√ºgen:

```sql
SELECT
  timestamp AS time,
  power AS 'Leistung'
FROM power_data
WHERE device_id = 'shelly1pmminig3-d0cf13cb5dd8'
  AND $__timeFilter(timestamp)
ORDER BY timestamp ASC
```

**Einstellungen:**
- **Title:** Leistungsverlauf
- **Unit:** Watt (W)
- **Graph style:** Area (f√ºr gef√ºllte Fl√§che)

### 4.5 Aktueller Verbrauch als Gauge

F√ºr eine Anzeige des aktuellen Werts:

```sql
SELECT
  power AS 'Aktuell'
FROM power_data
WHERE device_id = 'shelly1pmminig3-d0cf13cb5dd8'
ORDER BY timestamp DESC
LIMIT 1
```

**Einstellungen:**
- **Visualization:** Gauge
- **Title:** Aktuelle Leistung
- **Unit:** Watt (W)
- **Min:** 0
- **Max:** 1000 (oder dein erwarteter Maximalwert)
- **Thresholds:** Gr√ºn bis 100W, Gelb bis 500W, Rot dar√ºber

### 4.6 Switch-Events als Tabelle

```sql
SELECT
  timestamp AS 'Zeit',
  CASE WHEN switch_state = 1 THEN 'Ein' ELSE 'Aus' END AS 'Status',
  event_type AS 'Quelle'
FROM switch_events
WHERE device_id = 'shelly1pmminig3-d0cf13cb5dd8'
  AND $__timeFilter(timestamp)
ORDER BY timestamp DESC
LIMIT 20
```

**Einstellungen:**
- **Visualization:** Table
- **Title:** Letzte Schaltvorg√§nge

---

## 5. Dashboard verfeinern

### 5.1 Panels anordnen

Ziehe die Panels an die gew√ºnschte Position. Ein bew√§hrtes Layout:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Temperatur & Feuchtigkeit       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Gauge Leistung  ‚îÇ   Leistungsverlauf  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           Switch-Events Tabelle         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.2 Auto-Refresh aktivieren

Oben rechts neben der Zeitauswahl:
- Klick auf das Refresh-Symbol
- W√§hle z.B. **5m** f√ºr automatische Aktualisierung alle 5 Minuten

### 5.3 Zeitraum als Standard setzen

1. W√§hle oben rechts deinen Standard-Zeitraum (z.B. "Last 24 hours")
2. Klick auf das Zahnrad-Symbol (Dashboard settings)
3. Unter **Time options** ‚Üí **Time zone**: Europe/Berlin
4. Speichern

### 5.4 Dashboard speichern

Klick auf das Disketten-Symbol oben rechts:
- **Name:** Shelly Smart Home
- **Folder:** General (oder einen eigenen Ordner erstellen)

---

## 6. Dashboard-Vorlage zum Import

Damit du nicht alles manuell einrichten musst, hier eine fertige Dashboard-Vorlage.

### 6.1 JSON importieren

1. **Dashboards** ‚Üí **New** ‚Üí **Import**
2. JSON-Code einf√ºgen (siehe unten)
3. Datenquelle ausw√§hlen
4. **Import** klicken

### 6.2 JSON-Vorlage

```json
{
  "title": "Shelly Smart Home",
  "tags": ["shelly", "smarthome", "iot"],
  "timezone": "Europe/Berlin",
  "refresh": "5m",
  "panels": [
    {
      "id": 1,
      "title": "Temperaturverlauf",
      "type": "timeseries",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
      "targets": [
        {
          "rawSql": "SELECT timestamp AS time, temperature AS 'Temperatur' FROM sensor_data WHERE $__timeFilter(timestamp) ORDER BY timestamp ASC",
          "format": "time_series"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "celsius"
        }
      }
    },
    {
      "id": 2,
      "title": "Aktuelle Leistung",
      "type": "gauge",
      "gridPos": {"h": 6, "w": 6, "x": 0, "y": 8},
      "targets": [
        {
          "rawSql": "SELECT power FROM power_data ORDER BY timestamp DESC LIMIT 1",
          "format": "table"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "watt",
          "min": 0,
          "max": 500,
          "thresholds": {
            "steps": [
              {"value": 0, "color": "green"},
              {"value": 100, "color": "yellow"},
              {"value": 300, "color": "red"}
            ]
          }
        }
      }
    },
    {
      "id": 3,
      "title": "Leistungsverlauf",
      "type": "timeseries",
      "gridPos": {"h": 6, "w": 18, "x": 6, "y": 8},
      "targets": [
        {
          "rawSql": "SELECT timestamp AS time, power AS 'Leistung' FROM power_data WHERE $__timeFilter(timestamp) ORDER BY timestamp ASC",
          "format": "time_series"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "watt",
          "custom": {
            "fillOpacity": 20
          }
        }
      }
    },
    {
      "id": 4,
      "title": "Schaltvorg√§nge",
      "type": "table",
      "gridPos": {"h": 6, "w": 24, "x": 0, "y": 14},
      "targets": [
        {
          "rawSql": "SELECT timestamp AS 'Zeit', CASE WHEN switch_state = 1 THEN 'Ein' ELSE 'Aus' END AS 'Status', event_type AS 'Quelle' FROM switch_events WHERE $__timeFilter(timestamp) ORDER BY timestamp DESC LIMIT 20",
          "format": "table"
        }
      ]
    }
  ],
  "schemaVersion": 38
}
```

**‚ö†Ô∏è Wichtig:** Nach dem Import musst du in jedem Panel die Device-IDs an deine Ger√§te anpassen!

---

## 7. Tipps f√ºr Fortgeschrittene

### 7.1 Variablen f√ºr Ger√§te-Auswahl

Statt Device-IDs hart zu codieren, kannst du ein Dropdown erstellen:

1. Dashboard Settings ‚Üí **Variables** ‚Üí **Add variable**
2. **Name:** device
3. **Type:** Query
4. **Query:** `SELECT DISTINCT device_id FROM sensor_data`

In den Panel-Queries dann: `WHERE device_id = '$device'`

### 7.2 Alerting einrichten

Grafana kann dich warnen, wenn Werte kritisch werden:

1. Panel bearbeiten ‚Üí **Alert** Tab
2. **Create alert rule**
3. Bedingung setzen, z.B.: `temperature > 30`
4. Benachrichtigung konfigurieren (E-Mail, Telegram, etc.)

### 7.3 Mobile Ansicht

Grafana ist responsive. F√ºr die beste Mobile-Erfahrung:
- Panels nicht zu breit machen
- Gauge und Stat-Panels f√ºr wichtige Werte
- Grafana Cloud App (optional)

---

## 8. Fazit: PHP oder Grafana?

Beide Ans√§tze haben ihre Berechtigung:

**Nutze das PHP-Dashboard wenn:**
- Du volle Kontrolle √ºber jeden Aspekt willst
- Du PHP/JavaScript lernen m√∂chtest
- Minimale Ressourcen wichtig sind
- Du kein weiteres System verwalten willst

**Nutze Grafana wenn:**
- Du schnell professionelle Dashboards brauchst
- Du Alerting und erweiterte Features willst
- Mehrere Datenquellen zusammenf√ºhren m√∂chtest
- Du interaktive Zeitraum-Auswahl sch√§tzt

**Oder nutze beides:** PHP-Dashboard f√ºr die schnelle √úbersicht, Grafana f√ºr tiefe Analysen.

---

## Zusammenfassung der Serie

In dieser Artikelserie hast du ein komplettes lokales Smart Home Monitoring aufgebaut:

1. **Teil 1:** [Shelly-Grundlagen](https://diytechadventures.de/shelly-im-smarthome/) ‚Äì Plattform kennenlernen
2. **Teil 2:** [Scripting](https://diytechadventures.de/shelly-scripting/) ‚Äì Erste Automatisierungen
3. **Teil 3:** [Datenbank-Integration](https://diytechadventures.de/shelly-datenbank-integration/) ‚Äì MySQL/MariaDB anbinden
4. **Teil 4:** [BLU-Gateway](https://diytechadventures.de/shelly-blu-fcd2-pakete/) ‚Äì Bluetooth-Sensoren auswerten
5. **Teil 5a:** [PHP-Dashboard](https://diytechadventures.de/shelly-dashboard/) ‚Äì Eigene Visualisierung bauen
6. **Teil 5b:** Grafana-Integration ‚Äì Professionelle Dashboards (dieser Artikel)

Alle Daten bleiben bei dir ‚Äì kein Cloud-Zwang, volle Kontrolle, maximaler Datenschutz.

---

## Downloads

- [Dashboard-Vorlage (JSON)](#) ‚Äì *Link zu GitHub*
- [Alle Projektdateien auf GitHub](https://github.com/diytechadventures/DIYTechAdventures-Blog/tree/main/Smarthome-mit-Shelly)

---

Hast du Fragen oder Anregungen? Schreib mir in den Kommentaren!

*Zur√ºck zur √úbersicht: [Shelly Smart Home Serie](https://diytechadventures.de/projekte)*
